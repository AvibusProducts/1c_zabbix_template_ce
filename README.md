# 1c_zabbix_template_ce (Community Edition)
Шаблон (для Zabbix 4.4): конфигурационные файлы агента и вспомогательные скрипты для мониторинга серверов 1С Предприятия под GNU/Linux с помощью Zabbix
## Выбранная архитектура
Шаблон разбит на несколько составляющих по функциональному назначению:
* Шаблон для мониторинга рабочего сервера 1С Предприятия
* Шаблон для мониторинга сервера лицензирования
* Шаблон для мониторинга центрального сервера

## Установка
На сервере Zabbix необходимо добавить (экспортировать) файлы шаблонов:
* 1c_central_server.xml;
* 1c_license_server.xml;
* 1c_work_server.xml;
* 1c_valuemaps.xml.

После чего назначить необходимый шаблон(ы) хосту, на котором работает 1С Предприятие. В шаблонах имеются макросы, позволяющие задавать требуемые пороги реагирования Zabbix (срабатывания триггеров).

На сервере с 1С Предприятием необходимо установить все скрипты по структуре каталогов репозитория (структура каталогов соответствует используемой в <b>CentOS</b>).

Из файла <b>/opt/1C/noarch/conf/logcfg_zabbix_template.xml</b> необходимо перенести секции <b>log</b> в файл <b>logcfg.xml</b> рабочего сервера 1С Предприятия (или просто скопировать его в каталог /opt/1C/v8.3/тип_архитектуры/conf/, если сбор ТЖ не использовался).

<b>ВАЖНО:</b> Для корректной работы скриптов на сервере 1С Предприятия должны быть установлены следующие программы: zabbix-sender, zabbix-get, gawk (именно GNU AWK) и bc. Так же должен быть запущен RAS на центральном сервере кластера.
### Макросы для рабочего сервера
В шаблоне рабочего сервера есть следующие макросы:
* {$LOG_DIR} - каталог для хранения файлов технологического журнала;
* {$MAX_LOCK_WAIT} - пороговое значение (в секундах за час) суммарного ожидания на управляемых блокировках, по превышении которого срабатывает триггер;
* {$TOP_LIST_SIZE} - количество выдаваемых (сохраняемых) записей в агригированных выборках по серверным вызовам;
* {$RAS_PORT} - порт сервера(ов) RAS, для кластера(ов), в котором(ых) участвует данный рабочий сервер;
* {$RPHOST_MAX_MEM} - пороговое значение суммарного объема памяти, занимаемого процессами rphost, по превышении которого срабатывает триггер;
* {$EXCP_THRESHOLD} - пороговое количество исключений на один процесс, по превышении которого срабатывает триггер.
### Макросы для сервера лицензирования
В шаблоне сервера лицензирования есть следующие макросы:
* {$LIC_CORP} - флаг использования лицензий КОРП (1 - используются КОРП, 0 - используются ПРОФ). Для чего это нужно, можно ознакомиться по ссылке https://its.1c.ru/db/v8314doc#bookmark:adm:TI000000971;
* {$LIC_UTIL_LIMIT} - значение отношения количества использованных лицензий к количеству сеансов, лицензируемых клиентскими лицензиями, активированными на данном сервере, по превышении которого срабатывает триггер с предупреждением о скором исчерпании имеющихся лицензий;
* {$RAS_PORT} - порт сервера(ов) RAS, для кластера(ов), в котором(ых) участвует данный сервер лицензирования.
### Макросы для центрального сервера
В шаблоне рабочего сервера есть следующие макросы:
* {$RAS_PORT} - порт сервера RAS, для кластера, в котором данный сервер является центральным.
## Мониторинг рабочего сервера
Для мониторинга роли <b>Рабочего сервера</b> реализован сбор следующих показателей:
* Количество процессов ragent;
* Суммарный объем памяти всех процессов ragent;
* Количество исключений (событий EXCP) возникших в процессах ragent;
* Количество процессов rmngr;
* Суммарный объем памяти всех процессов rmngr;
* Количество исключений (событий EXCP) возникших в процессах rmngr;
* Количество процессов rphost;
* Суммарный объем памяти всех процессов rphost;
* Количество исключений (событий EXCP) возникших в процессах rphost;
* Изменение в списке рабочих процессов;
* Количество таймаутов на управляемых блокировках (по-умолчанию деактивирован);
* Количество взаимоблокировок на управляемых блокировках (по-умолчанию деактивирован);
* Суммарное время ожидания на управляемых блокировках (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарной длительности (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному процессорному времени (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному вводу-выводу (по-умолчанию деактивирован);
* ТОП серверных вызовов по средней длительности (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному количеству (по-умолчанию деактивирован);
* ТОП серверных вызовов по максимальной памяти за вызов (по-умолчанию деактивирован);
* ТОП "ленивых" (с большой длительностью и малым процессорным временем) серверных вызовов (по-умолчанию деактивирован);
* Объем оперативной памяти сервера.
### Триггеры
Для отслеживания критичных изменений показателей роли <b>Рабочеого сервера</b> созданы триггеры, срабатывающие при следующих событиях:
* Отсутствуют процессы ragent. Уровень важности - <b>Высокая</b>;
* Отсутствуют процессы rmngr. Уровень важности - <b>Высокая</b>;
* Отсутствуют процессы rphost. Уровень важности - <b>Высокая</b>;
* В списке процессов rphost происходят частые измеенния. Уровень важности - <b>Высокая</b>;
* Превышено пороговое значение объема памяти, занимаемого процессами rphost (регулируется макросом {$RPHOST_MAX_MEM}). Уровень важности - <b>Средняя</b>;
* Обнаружены таймауты на управляемых блокировках 1С. Уровень важности - <b>Высокая</b>;
* Обнаружены взаимоблокировки на управляемых блокировках 1С. Уровень важности - <b>Высокая</b>;
* Превышено пороговое значение ожидания на управляемых блокировках 1С, регулируемое макросом {$MAX_LOCK_WAIT}. Уровень важности - <b>Высокая</b>;
* Количество исключений по процессам ragent превышает {$EXCP_THRESHOLD}. Уровень важности <b>Высокая</b>;
* Количество исключений по процессам rmngr превышает {$EXCP_THRESHOLD}. Уровень важности - <b>Высокая</b>;
* Количество исключений по процессам rphost превышает {$EXCP_THRESOLD}. Уровень важности - <b>Высокая</b>;
* Отсутствуют события TLOCK. Уровень важности - <b>Информация</b>.
### Графики
Для визуализации показателей роли <b>Рабочего сервера</b> предусмотрены следущие графики:
* Количество ошибок по процессам ragent, rmngr и rphost;
* Объем используемой памяти процессами сервера 1С Предприятия в разрезе ragent, rmngr и rphost. 
## Мониторинг сервера лицензирования
Для мониторинга роли <b>Сервера лицензирования</b> реализован сбор следующих показателей:
* Общее количество сеансов на серверах кластера, в котором участвует данный сервер лицензирования;
* Количество файлов клиентских лицензий, активированных на данном сервере;
* Количество сеансов лицензируемых клиенскими (программными) лицензиями, активированными на данном сервере;
* Количество сеансов лицензируемых клиентскими лицензиями с пользовательских компьютеров;
* Количество сеансов, использующих веб-клиент;
* Количество использованных лицензий (выданных данным сервером).
### Тригеры
Для отслеживания критичных изменений показателей роли <b>Сервера лицензирования</b> созданы триггеры, срабатывающие при следующих событиях:
* Количество лицензий, выданных данным сервером лицензирования, превышает пороговое значение, регулируемое макросом {$LIC_UTIL_LIMIT}. Уровень важности - <b>Предупреждение</b>;
* Использованы все активированные лицензии, т.е. количество сеансов с лицензией, выданной данным сервером лицензирования, равно количеству клиентских лицензий активированных на данном сервере. Уровень важности - <b>Высокая</b>;
* При работе с кластером 1С Предприятия используются локальные пользовательские лицензии (по-умолчанию деактивирован). Уровень важности - <b>Информация</b>;
* Количество локальных пользовательских лицензий превышает 50% (по-умолчанию деактивирован). Уровень важности - <b>Предупреждение</b>.
### Графики
Для визуализации показателей роли <b>Cервера лицензирования</b> предусмотрены следущие графики:
* Использование активированных лицензий.
### Обследование
В случае, когда сервер лицензирования входит состав нескольких кластеров 1С Предприятия, для мониторинга использования лицензий в разрезе данных кластров необходимо активировать <b>обследование</b> (по-умолчнию деактивировано). После этого, собираемые показатели и графики станут доступны в разрезе кластеров, в которых принимает участие данный сервер лицензирования. 
## Мониторинг центрального сервера
Для мониторинга роли <b>Центрального сервера</b> реализован сбор следующих показателей:
* Доступность сервиса RAS по сетевому порту.
### Триггеры
Для отслеживания критичных изменений показателей роли <b>Центрального сервера</b> созданы триггеры, срабатывающие при следующих событиях:
* Сетевой порт сервиса RAS недоступен (не отвечает). Уровень важности - <b>Средняя</b>
## Статьи о данном шаблоне (с картинками)
* Про блокировки - https://infostart.ru/public/1120500/
* Про лицензии - https://infostart.ru/public/1114020/, https://infostart.ru/public/1157013/
