# 1c_zabbix_template_ce (Community Edition)
Шаблон (для Zabbix 4.4): конфигурационные файлы агента и вспомогательные скрипты для мониторинга серверов 1С Предприятия под GNU/Linux с помощью Zabbix
## Выбранная архитектура
Шаблон разбит на несколько составляющих по функциональному назначению:
* Шаблон для мониторинга рабочего сервера 1С Предприятия
* Шаблон для мониторинга сервера лицензирования (наследует шаблон рабочего сервера)
* Шаблон для мониторинга центрального сервера

## Установка
На сервере Zabbix необходимо добавить (экспортировать) файлы шаблонов:
* 1c_central_server.xml;
* 1c_work_server.xml;
* 1c_license_server.xml;
* 1c_valuemaps.xml.

**ВАЖНО:** Так как шаблон сервера лицензирования стал наследовать шаблон рабочего сервера, то импорт шаблона рабочего сервера должен предшестовать импорту шаблона сервера лицензирования!

После чего назначить необходимый шаблон(ы) хосту, на котором работает 1С Предприятие. В шаблонах имеются макросы, позволяющие задавать требуемые пороги реагирования Zabbix (срабатывания триггеров).

На сервере с 1С Предприятием необходимо установить все скрипты по структуре каталогов репозитория (структура каталогов соответствует используемой в **CentOS**). А так же создать каталог для файлов технологического журнала (по-умолчанию **/var/log/1C**), в котором должен быть создан каталлог **zabbix** с вложенным каталогом **problem_log**. Таким образом, в рабочей системе структура каталогов и права на них выглядят следующим образом
<pre>$ ls -al /var/log/1C/zabbix/
итого 24
drwxr-xr-x 6 usr1cv8 grp1cv8 4096 Feb 25 12:29 .
drwxr-xr-x 4 root    root    4096 Feb 25 12:29 ..
drwxr-xr-x 2 usr1cv8 grp1cv8 4096 Aug 27  2019 calls
drwxr-xr-x 2 usr1cv8 grp1cv8 4096 Feb 25 12:29 excps
drwxr-xr-x 2 usr1cv8 grp1cv8 4096 Aug 27  2019 locks
drwxr-xr-x 2 zabbix  grp1cv8 4096 Aug 27  2019 problem_log
</pre>

Из файла **/opt/1C/noarch/conf/logcfg_zabbix_template.xml** необходимо перенести секции **log** в файл **logcfg.xml** рабочего сервера 1С Предприятия (или просто скопировать его в каталог /opt/1C/v8.3/тип_архитектуры/conf/, если сбор ТЖ не использовался).

**ВАЖНО:** Для корректной работы скриптов на сервере 1С Предприятия должны быть установлены следующие программы: zabbix-sender, zabbix-get, gawk (именно GNU AWK) и bc. Так же должен быть запущен RAS на центральном сервере кластера.

**ВАЖНО:** В случае многосерверного кластера 1С Предприятия, для корректной работы механизма сохранения файлов "проблемного" технологического журнала, необходимо на всех серверах, входящих в кластер, в настройке **Server** агента zabbix указать все сервера, входящие в кластер. Например, для кластера из двух серверов (**server_a** и **server_b**) на обоих серверах данная настройка агента zabbix должна выглядеть следующим образом:
<pre>Server=server_zabbix,server_a,server_b</pre>

### Макросы для рабочего сервера
В шаблоне рабочего сервера есть следующие макросы:
* {$LOG_DIR} - каталог для хранения файлов технологического журнала;
* {$MAX_LOCK_WAIT} - пороговое значение (в секундах за час) суммарного ожидания на управляемых блокировках, по превышении которого срабатывает триггер;
* {$TOP_LIST_SIZE} - количество выдаваемых (сохраняемых) записей в агригированных выборках по серверным вызовам;
* {$RAS_PORT} - порт сервера(ов) RAS, для кластера(ов), в котором(ых) участвует данный рабочий сервер;
* {$RPHOST_MAX_MEM} - пороговое значение суммарного объема памяти, занимаемого процессами rphost, по превышении которого срабатывает триггер;
* {$EXCP_THRESHOLD} - пороговое количество исключений на один процесс, по превышении которого срабатывает триггер.
### Макросы для сервера лицензирования
В шаблоне сервера лицензирования есть следующие макросы:
* {$LIC_CORP} - флаг использования лицензий КОРП (1 - используются КОРП, 0 - используются ПРОФ). Для чего это нужно, можно ознакомиться по ссылке https://its.1c.ru/db/v8314doc#bookmark:adm:TI000000971;
* {$LIC_UTIL_LIMIT} - значение отношения количества использованных лицензий к количеству сеансов, лицензируемых клиентскими лицензиями, активированными на данном сервере, по превышении которого срабатывает триггер с предупреждением о скором исчерпании имеющихся лицензий.
### Макросы для центрального сервера
В шаблоне рабочего сервера есть следующие макросы:
* {$RAS_PORT} - порт сервера RAS, для кластера, в котором данный сервер является центральным.
## Мониторинг рабочего сервера
Для мониторинга роли <b>Рабочего сервера</b> реализован сбор следующих показателей:
* Количество процессов ragent;
* Суммарный объем памяти всех процессов ragent;
* Количество исключений (событий EXCP) возникших в процессах ragent;
* Количество процессов rmngr;
* Суммарный объем памяти всех процессов rmngr;
* Количество исключений (событий EXCP) возникших в процессах rmngr;
* Количество процессов rphost;
* Суммарный объем памяти всех процессов rphost;
* Количество исключений (событий EXCP) возникших в процессах rphost;
* Изменение в списке рабочих процессов;
* Количество событий об управляемых блокировках - TLOCK (по-умолчанию деактивирован);
* Количество таймаутов на управляемых блокировках (по-умолчанию деактивирован);
* Количество взаимоблокировок на управляемых блокировках (по-умолчанию деактивирован);
* Суммарное время ожидания на управляемых блокировках (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарной длительности (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному процессорному времени (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному вводу-выводу (по-умолчанию деактивирован);
* ТОП серверных вызовов по средней длительности (по-умолчанию деактивирован);
* ТОП серверных вызовов по суммарному количеству (по-умолчанию деактивирован);
* ТОП серверных вызовов по максимальной памяти за вызов (по-умолчанию деактивирован);
* ТОП "ленивых" (с большой длительностью и малым процессорным временем) серверных вызовов (по-умолчанию деактивирован);
* Объем оперативной памяти сервера.
### Триггеры
Для отслеживания критичных изменений показателей роли <b>Рабочеого сервера</b> созданы триггеры, срабатывающие при следующих событиях:
* Отсутствуют процессы ragent. Уровень важности - <b>Высокая</b>;
* Отсутствуют процессы rmngr. Уровень важности - <b>Высокая</b>;
* Отсутствуют процессы rphost. Уровень важности - <b>Высокая</b>;
* В списке процессов rphost происходят частые измеенния. Уровень важности - <b>Высокая</b>;
* Превышено пороговое значение объема памяти, занимаемого процессами rphost (регулируется макросом {$RPHOST_MAX_MEM}). Уровень важности - <b>Средняя</b>;
* Обнаружены таймауты на управляемых блокировках 1С. Уровень важности - <b>Высокая</b>;
* Обнаружены взаимоблокировки на управляемых блокировках 1С. Уровень важности - <b>Высокая</b>;
* Превышено пороговое значение ожидания на управляемых блокировках 1С, регулируемое макросом {$MAX_LOCK_WAIT}. Уровень важности - <b>Высокая</b>;
* Количество исключений по процессам ragent превышает {$EXCP_THRESHOLD}. Уровень важности <b>Средняя</b>;
* Количество исключений по процессам rmngr превышает {$EXCP_THRESHOLD}. Уровень важности - <b>Средняя</b>;
* Количество исключений по процессам rphost превышает {$EXCP_THRESHOLD}. Уровень важности - <b>Средняя</b>;
* Отсутствуют события TLOCK. Уровень важности - <b>Информация</b>.
### Графики
Для визуализации показателей роли <b>Рабочего сервера</b> предусмотрены следущие графики:
* Количество ошибок по процессам ragent, rmngr и rphost;
* Объем используемой памяти процессами сервера 1С Предприятия в разрезе ragent, rmngr и rphost. 
## Мониторинг сервера лицензирования
Для мониторинга роли **Сервера лицензирования** реализован сбор следующих показателей:
* Общее количество сеансов на серверах кластера, в котором участвует данный сервер лицензирования;
* Количество файлов клиентских лицензий, активированных на данном сервере;
* Количество сеансов лицензируемых клиенскими (программными) лицензиями, активированными на данном сервере;
* Количество сеансов лицензируемых клиентскими лицензиями с пользовательских компьютеров;
* Количество сеансов, использующих веб-клиент;
* Количество использованных лицензий (выданных данным сервером).

**СОВЕТ:** Для надежного получения значений по сеансам необходимо на сервере лицензирования увеличить таймаут zabbibx-агента в зависимости от количество кластеров, в состав которых входит сервер лицензирования, количества информационных баз и общего количества сеансов. Рекомендуемое значение - **10 сек**.
### Тригеры
Для отслеживания критичных изменений показателей роли **Сервера лицензирования** созданы триггеры, срабатывающие при следующих событиях:
* Количество лицензий, выданных данным сервером лицензирования, превышает пороговое значение, регулируемое макросом {$LIC_UTIL_LIMIT}. Уровень важности - **Предупреждение**;
* Использованы все активированные лицензии, т.е. количество сеансов с лицензией, выданной данным сервером лицензирования, равно количеству клиентских лицензий активированных на данном сервере. Уровень важности - **Высокая**;
* При работе с кластером 1С Предприятия используются локальные пользовательские лицензии (по-умолчанию деактивирован). Уровень важности - **Информация**;
* Количество локальных пользовательских лицензий превышает 50% (по-умолчанию деактивирован). Уровень важности - **Предупреждение**;
* Уменьшение числа процессов менеджера кластера по сравнению со средней величиной за последние 10 минут. Уровень важности - **Высокая**.
### Графики
Для визуализации показателей роли **Cервера лицензирования** предусмотрены следущие графики:
* Использование активированных лицензий.
### Обследование
В случае, когда сервер лицензирования входит состав нескольких кластеров 1С Предприятия, для мониторинга использования лицензий в разрезе данных кластров необходимо активировать <b>обследование</b> (по-умолчнию деактивировано). После этого, собираемые показатели и графики станут доступны в разрезе кластеров, в которых принимает участие данный сервер лицензирования. 
## Мониторинг центрального сервера
Для мониторинга роли **Центрального сервера** реализован сбор следующих показателей:
* Доступность сервиса RAS по сетевому порту.
### Триггеры
Для отслеживания критичных изменений показателей роли **Центрального сервера** созданы триггеры, срабатывающие при следующих событиях:
* Сетевой порт сервиса RAS недоступен (не отвечает). Уровень важности - **Средняя**
## Статьи о данном шаблоне (с картинками)
* Про блокировки - https://infostart.ru/public/1120500/
* Про лицензии - https://infostart.ru/public/1114020/, https://infostart.ru/public/1157013/
